<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Avatar Brigitte Interactivo</title>
    <style>
        body { margin: 0; background: #f0f0f0; font-family: Arial; }
        #container { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #avatar { width: 200px; height: 200px; border-radius: 50%; position: relative; overflow: hidden; }
        #avatar-video { width: 100%; height: 100%; object-fit: cover; }
        #chat { margin-top: 20px; width: 300px; }
        #input { width: 100%; padding: 10px; }
        #output { height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        button { padding: 10px; margin: 5px; }
        .error { color: red; font-size: 12px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="avatar">
            <video id="avatar-video" src="brigitte.mp4" muted playsinline></video>
        </div>
        <div id="chat">
            <div id="output">Brigitte: ¡Hola, Vicente! ¿Qué tal ese solo de guitarra hoy?</div>
            <div id="mic-status" class="error"></div>
            <input type="text" id="input" placeholder="Escribe o habla..." />
            <button onclick="sendText()">Enviar Texto</button>
            <button onclick="requestMicPermission()">Solicitar Permiso Mic (Una Vez)</button>
            <button onclick="startVoice()">Hablar</button>
            <button onclick="stopVoice()">Parar Voz</button>
        </div>
    </div>

    <script>
        const output = document.getElementById('output');
        const input = document.getElementById('input');
        const video = document.getElementById('avatar-video');
        const micStatus = document.getElementById('mic-status');
        let recognition;
        let synthesis = window.speechSynthesis;
        let isSpeaking = false;
        let micPermissionGranted = false;

        // Simula respuesta de IA (en real, usa Grok API)
        function getResponse(userInput) {
            const responses = [
                "¡Suena genial, polifacético! Cuéntame más de esa soldadura SMD.",
                "¡Ja! Como un buen cerrojo: directo y sin fallos. ¿Próximo curso?",
                "¡Visionario! El pasado enseña, pero tú innovas. ¿Guitarra o electrónica hoy?"
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function speak(text) {
            if (isSpeaking) synthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.onstart = () => { isSpeaking = true; video.currentTime = 0; video.play(); };
            utterance.onend = () => { isSpeaking = false; video.pause(); video.currentTime = 0; };
            synthesis.speak(utterance);
        }

        function sendText() {
            const userText = input.value.trim();
            if (!userText) return;
            output.innerHTML += `<br>Vicente: ${userText}`;
            input.value = '';
            const botResponse = getResponse(userText);
            setTimeout(() => {
                output.innerHTML += `<br>Brigitte: ${botResponse}`;
                speak(botResponse);
                output.scrollTop = output.scrollHeight;
            }, 500);
        }

        async function requestMicPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // Libera inmediatamente
                micPermissionGranted = true;
                micStatus.textContent = '¡Mic OK! Ya no pedirá más.';
                micStatus.style.color = 'green';
            } catch (err) {
                micStatus.textContent = 'Error: Permiso denegado. Ve a chrome://settings/content/microphone y permite.';
                console.error('Mic error:', err);
            }
        }

        function startVoice() {
            if (!micPermissionGranted) {
                micStatus.textContent = '¡Ey! Solicita permiso primero con el botón.';
                return;
            }
            if (!('webkitSpeechRecognition' in window)) {
                alert('¡Ey! Tu navegador no soporta voz. Usa Chrome.');
                return;
            }
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.interimResults = false;
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                input.value = transcript;
                sendText();
            };
            recognition.onerror = (e) => {
                console.error('Error voz:', e.error);
                micStatus.textContent = 'Error en reconocimiento: ' + e.error;
            };
            recognition.start();
        }

        function stopVoice() {
            if (recognition) recognition.stop();
        }

        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendText(); });
    </script>
</body>
</html>